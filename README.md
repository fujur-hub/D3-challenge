This was tough. took me about 10 hours even with the solution.